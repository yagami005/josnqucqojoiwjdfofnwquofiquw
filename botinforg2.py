import datetime
import requests
import telebot
import time
import json
import csv
import os
import random

class WebScraper:
    
    def __init__(self):
        # Configura√ß√µes
        self.game = "Blaze Double"
        self.token = '7486302148:AAHORAtaTUzv_z62SnjJEIeNcllrPeRwYiU'
        self.chat_id = '-1002310257460'
        self.url_API = 'https://blaze.bet.br/api/singleplayer-originals/originals/roulette_games/recent/1'
        self.gales = 2  # Ajustado para 2 gales
        self.protection = True
        self.link = 'blaze-codigo.com/r/WKPQ6'

        # Contadores de resultados
        self.win_results = 0
        self.branco_results = 0
        self.loss_results = 0
        self.max_hate = 0
        self.win_hate = 0
        self.wins_without_gale = 0
        self.wins_martingale_1 = 0
        self.wins_martingale_2 = 0

        # Atributos auxiliares
        self.count = 0
        self.analisar = True
        self.direction_color = 'None'
        self.message_delete = False
        self.bot = telebot.TeleBot(token=self.token, parse_mode='MARKDOWN')
        self.date_now = str(datetime.datetime.now().strftime("%d/%m/%Y"))
        self.check_date = self.date_now
        self.current_pattern = None

        # Atributo para armazenar os padr√µes indicados
        self.report_data = []

        # Arquivos de estrat√©gia
        self.strategy_files = ["estrategy1.csv", "estrategy2.csv"]
        self.current_strategy_file = 0

    def restart(self):
        if self.date_now != self.check_date:
            print('Reiniciando bot!')
            self.check_date = self.date_now
            self.bot.send_sticker(self.chat_id, sticker='CAACAgEAAxkBAAEBbJJjXNcB92-_4vp2v0B3Plp9FONrDwACvgEAAsFWwUVjxQN4wmmSBCoE')
            self.results()

            # Zera os resultados
            self.win_results = 0
            self.loss_results = 0
            self.branco_results = 0
            self.wins_without_gale = 0
            self.wins_martingale_1 = 0
            self.wins_martingale_2 = 0
            self.max_hate = 0
            self.win_hate = 0
            time.sleep(10)

            self.bot.send_sticker(self.chat_id, sticker='CAACAgEAAxkBAAEBPQZi-ziImRgbjqbDkPduogMKzv0zFgACbAQAAl4ByUUIjW-sdJsr6CkE')
            self.results()
            return True
        else:
            return False

    def results(self):
        if self.win_results + self.branco_results + self.loss_results != 0:
            a = 100 / (self.win_results + self.branco_results + self.loss_results) * (self.win_results + self.branco_results)
        else:
            a = 0
        self.win_hate = (f'{a:,.2f}%')

        self.bot.send_message(chat_id=self.chat_id, text=(f'''
‚ñ∫ PLACAR GERAL = ‚úÖ{self.win_results} | ‚ö™Ô∏è{self.branco_results} | üö´{self.loss_results}
‚ñ∫ WINS: 
   - Sem Gale: {self.wins_without_gale}
   - Gale 1: {self.wins_martingale_1}
   - Gale 2: {self.wins_martingale_2}
‚ñ∫ Consecutivas = {self.max_hate}
‚ñ∫ Assertividade = {self.win_hate}
'''))
        return

    def alert_sinal(self):
        message_id = self.bot.send_message(self.chat_id, text='''‚ö†Ô∏è ANALISANDO, FIQUE ATENTO!!!''').message_id
        self.message_ids = message_id
        self.message_delete = True
        return

    def alert_gale(self):
        if self.count <= self.gales:
            gale_number = self.count
            gale_message = f'‚ö†Ô∏è Vamos para o {gale_number}¬™ GALE'
        else:
            gale_number = self.count - self.gales
            gale_message = f'‚ö†Ô∏è Vamos para o {gale_number}¬™ GALE EXTRA'
        self.message_ids = self.bot.send_message(self.chat_id, text=gale_message).message_id
        self.message_delete = True
        return

    def delete(self):
        if self.message_delete == True:
            try:
                self.bot.delete_message(chat_id=self.chat_id, message_id=self.message_ids)
            except telebot.apihelper.ApiException as e:
                print(f"Error deleting message: {e}")
            self.message_delete = False

    def get_last_pattern_result(self, pattern):
        """Retorna o √∫ltimo resultado (WIN/LOSS/BRANCO) para o padr√£o especificado no dia atual"""
        today = datetime.datetime.now().strftime("%d/%m/%Y")
        try:
            with open('report_history.csv', 'r', encoding='utf-8') as f:
                reader = csv.DictReader(f)
                for row in reversed(list(reader)):
                    if row['Padrao'] == ''.join(pattern) and row['Data'] == today:
                        return row['Resultado']
        except FileNotFoundError:
            pass
        return "N/A"

    def calculate_average_wins(self, pattern):
        """Calcula a m√©dia de wins consecutivos para o padr√£o no dia atual"""
        pattern_str = ''.join(pattern)
        win_streaks = []
        current_streak = 0
        today = datetime.datetime.now().strftime("%d/%m/%Y")
        
        try:
            with open('report_history.csv', 'r', encoding='utf-8') as f:
                reader = csv.DictReader(f)
                for row in reader:
                    if row['Padrao'] == pattern_str and row['Data'] == today:
                        if row['Resultado'] in ['WIN', 'BRANCO']:
                            current_streak += 1
                        else:
                            if current_streak > 0:
                                win_streaks.append(current_streak)
                            current_streak = 0
                if current_streak > 0:  # Adiciona a sequ√™ncia atual se terminou em WIN/BRANCO
                    win_streaks.append(current_streak)
        except FileNotFoundError:
            pass
        
        return round(sum(win_streaks)/len(win_streaks), 1) if win_streaks else 0

    def get_pattern_count_today(self, pattern):
        """Conta quantas vezes o padr√£o apareceu hoje"""
        pattern_str = ''.join(pattern)
        today = datetime.datetime.now().strftime("%d/%m/%Y")
        count = 0
        
        try:
            with open('report_history.csv', 'r', encoding='utf-8') as f:
                reader = csv.DictReader(f)
                for row in reader:
                    if row['Padrao'] == pattern_str and row['Data'].startswith(today):
                        count += 1
        except FileNotFoundError:
            pass
        
        return count

    def save_to_history(self, pattern, result):
        """Salva cada entrada no hist√≥rico completo"""
        headers = ['Data', 'Hora', 'Padrao', 'Resultado', 'Estagio']
        data = {
            'Data': datetime.datetime.now().strftime("%d/%m/%Y"),
            'Hora': datetime.datetime.now().strftime("%H:%M:%S"),
            'Padrao': ''.join(pattern),
            'Resultado': result,
            'Estagio': f'Martingale {self.count}' if self.count <= self.gales else f'Gale {self.count - self.gales}'
        }
        
        file_exists = os.path.isfile('report_history.csv')
        
        with open('report_history.csv', 'a', newline='', encoding='utf-8') as f:
            writer = csv.DictWriter(f, fieldnames=headers)
            if not file_exists:
                writer.writeheader()
            writer.writerow(data)

    def get_last_number(self):
        """Obt√©m o √∫ltimo n√∫mero da API"""
        try:
            response = requests.get(self.url_API, timeout=10)
            json_data = json.loads(response.text)
            if json_data and isinstance(json_data, list) and 'roll' in json_data[0]:
                return json_data[0]['roll']
        except Exception as e:
            print(f"Erro ao obter √∫ltimo n√∫mero: {e}")
        return None

    def get_pattern_stats(self, padrao):
        file_path = "report.csv"
        pattern_str = ''.join(padrao)

        if os.path.exists(file_path):
            with open(file_path, 'r', encoding='utf-8') as csvfile:
                reader = csv.DictReader(csvfile)
                for row in reader:
                    if row['Padrao'] == pattern_str:
                        return {
                            "Martingale 0": row["Martingale 0"],
                            "Martingale 1": row["Martingale 1"],
                            "Martingale 2": row["Martingale 2"],
                            "Branco 0": row["Branco 0"],
                            "Branco 1": row["Branco 1"],
                            "Branco 2": row["Branco 2"],
                            "Loss": row["Loss"]
                        }
        return None


    def send_sinal(self, padrao):
        print("Sinal enviado, aguardando resultado...")
        self.current_pattern = padrao
        emotes = {'V': 'üî¥', 'P': '‚ö´Ô∏è', 'B': '‚ö™Ô∏è'}
        padrao_emotes = ''.join(emotes.get(char, char) for char in padrao)
        self.analisar = False
        
        pattern_stats = self.get_pattern_stats(padrao)
        last_number = self.get_last_number()
        count_today = self.get_pattern_count_today(padrao)
        ultimo_resultado = self.get_last_pattern_result(padrao)
        media_wins = self.calculate_average_wins(padrao)
        
        pattern_str = ''.join(padrao)
        today = datetime.datetime.now().strftime("%d/%m/%Y")
        wins_sem_gale = 0
        wins_gale1 = 0
        wins_gale2 = 0
        brancos = 0
        losses = 0
        
        # Contagem ajustada para todas as apari√ß√µes do padr√£o no dia
        try:
            with open('report_history.csv', 'r', encoding='utf-8') as f:
                reader = csv.DictReader(f)
                for row in reader:
                    if row['Padrao'] == pattern_str and row['Data'] == today:
                        if row['Resultado'] == 'WIN':
                            if row['Estagio'] == 'Martingale 0':
                                wins_sem_gale += 1
                            elif row['Estagio'] == 'Martingale 1':
                                wins_gale1 += 1
                            elif row['Estagio'] == 'Martingale 2':
                                wins_gale2 += 1
                        elif row['Resultado'] == 'BRANCO':
                            brancos += 1
                        elif row['Resultado'] == 'LOSS':
                            losses += 1
        except FileNotFoundError:
            pass
        
        total_today = wins_sem_gale + wins_gale1 + wins_gale2 + brancos + losses
        prob_win_today = ((wins_sem_gale + wins_gale1 + wins_gale2 + brancos) / total_today * 100) if total_today > 0 else 0
        
        if pattern_stats:
            try:
                total_wins = int(pattern_stats["Martingale 0"]) + int(pattern_stats["Martingale 1"]) + int(pattern_stats["Martingale 2"])
                total_brancos = int(pattern_stats["Branco 0"]) + int(pattern_stats["Branco 1"]) + int(pattern_stats["Branco 2"])
                total_losses = int(pattern_stats["Loss"])
                total_tries = total_wins + total_brancos + total_losses
                
                win_rate = (total_wins / total_tries * 100) if total_tries > 0 else 0
                branco_rate = (total_brancos / total_tries * 100) if total_tries > 0 else 0
                loss_rate = (total_losses / total_tries * 100) if total_tries > 0 else 0
                win_plus_branco_rate = ((total_wins + total_brancos) / total_tries * 100) if total_tries > 0 else 0
                
                # Dicas estrat√©gicas (mantive as profissionais da vers√£o anterior)
                dicas = []
                if ultimo_resultado == "LOSS":
                    loss_tips = [
                        "‚è≥ √öltimo resultado foi LOSS - Analise com cautela.",
                        "‚è≥ O padr√£o registrou LOSS recentemente - Observe o hist√≥rico.",
                        "‚è≥ √öltima tentativa resultou em LOSS - Avalie o momento.",
                        "‚è≥ LOSS anterior no padr√£o - Considere os riscos.",
                        "‚è≥ √öltima entrada terminou em LOSS - Verifique o contexto.",
                        "‚è≥ Padr√£o com LOSS recente - Prossiga com aten√ß√£o.",
                        "‚è≥ O √∫ltimo resultado foi LOSS - Examine o cen√°rio.",
                        "‚è≥ LOSS detectado na √∫ltima tentativa - Tenha cuidado.",
                        "‚è≥ √öltima ocorr√™ncia foi LOSS - Avalie o pr√≥ximo passo.",
                        "‚è≥ Registro de LOSS anterior - Considere a tend√™ncia.",
                        "‚è≥ √öltima chamada deu LOSS - Observe os detalhes.",
                        "‚è≥ Padr√£o com falha recente - Analise antes de agir.",
                        "‚è≥ LOSS na √∫ltima entrada - Verifique a Tend√™ncia atual.",
                        "‚è≥ Resultado anterior foi LOSS - Prossiga com prud√™ncia.",
                        "‚è≥ √öltimo padr√£o terminou em LOSS - Aten√ß√£o ao timing.",
                        "‚è≥ LOSS recente no hist√≥rico - Avalie o risco envolvido.",
                        "‚è≥ √öltima tentativa falhou - Considere os indicadores.",
                        "‚è≥ Padr√£o com LOSS pr√©vio - Observe o desempenho.",
                        "‚è≥ LOSS registrado anteriormente - Analise o padr√£o.",
                        "‚è≥ √öltima entrada foi LOSS - Verifique os sinais."
                    ]
                    dicas.append(random.choice(loss_tips))
                
                if win_rate >= 89:
                    hot_tips = [
                        f"üî• Taxa de acerto em {win_rate:.0f}% - Hist√≥rico elevado.",
                        f"üî• Padr√£o com {win_rate:.0f}% de sucesso - Desempenho consistente.",
                        f"üî• {win_rate:.0f}% Chance maior de Vit√≥ria.",
                        f"üî• Alta performance com {win_rate:.0f}% - Observe a tend√™ncia.",
                        f"üî• {win_rate:.0f}% de acerto no hist√≥rico - Taxa significativa.",
                        f"üî• Padr√£o registra {win_rate:.0f}% - chance de vit√≥ria mais elevada",
                        f"üî• {win_rate:.0f}% de sucesso at√© agora - Hist√≥rico favor√°vel.",
                        f"üî• Taxa elevada de {win_rate:.0f}% - Avalie a tend√™ncia.",
                        f"üî• {win_rate:.0f}% no padr√£o - Desempenho acima da m√©dia.",
                        f"üî• Hist√≥rico com {win_rate:.0f}% de acerto maior chance de vit√≥ria.",
                        f"üî• {win_rate:.0f}% de vit√≥rias - Taxa expressiva.",
                        f"üî• Padr√£o em {win_rate:.0f}% - Resultados consistentes.",
                        f"üî• Taxa de {win_rate:.0f}% acumulada - Observe a tend√™ncia.",
                        f"üî• {win_rate:.0f}% de acerto registrado - Tend√™ncia favoravel.",
                        f"üî• Padr√£o com {win_rate:.0f}% - Hist√≥rico positivo.",
                        f"üî• {win_rate:.0f}% de sucesso padr√£o quente.",
                        f"üî• Taxa de vit√≥rias em {win_rate:.0f}% - avalie a tend√™ncia.",
                        f"üî• {win_rate:.0f}% no hist√≥rico - Taxa alta registrada.",
                        f"üî• Padr√£o com {win_rate:.0f}% de acerto",
                        f"üî• {win_rate:.0f}% de vit√≥rias acumuladas."
                    ]
                    dicas.append(random.choice(hot_tips))
                elif win_rate <= 81:
                    risk_tips = [
                        f"‚ö†Ô∏è Taxa de {win_rate:.0f}% - Desempenho abaixo da m√©dia.",
                        f"‚ö†Ô∏è Apenas {win_rate:.0f}% de acerto - Considere os riscos.",
                        f"‚ö†Ô∏è Padr√£o com {win_rate:.0f}% - Hist√≥rico inst√°vel.",
                        f"‚ö†Ô∏è {win_rate:.0f}% de vit√≥rias - Avalie com cautela.",
                        f"‚ö†Ô∏è Taxa baixa de {win_rate:.0f}%.",
                        f"‚ö†Ô∏è {win_rate:.0f}% no padr√£o - Desempenho limitado.",
                        f"‚ö†Ô∏è Hist√≥rico com {win_rate:.0f}% - Observe a tend√™ncia.",
                        f"‚ö†Ô∏è {win_rate:.0f}% de acerto - Risco elevado presente.",
                        f"‚ö†Ô∏è Taxa de {win_rate:.0f}% acumulada - Analise a tend√™ncia.",
                        f"‚ö†Ô∏è Padr√£o em {win_rate:.0f}% - Resultados inconsistentes.",
                        f"‚ö†Ô∏è {win_rate:.0f}% de sucesso - Considere o hist√≥rico.",
                        f"‚ö†Ô∏è Taxa de vit√≥rias em {win_rate:.0f}% - Cuidado necess√°rio.",
                        f"‚ö†Ô∏è {win_rate:.0f}% no hist√≥rico - Desempenho fraco.",
                        f"‚ö†Ô∏è Padr√£o com {win_rate:.0f}% - risco alto.",
                        f"‚ö†Ô∏è {win_rate:.0f}% de acerto - Risco a ser considerado.",
                        f"‚ö†Ô∏è Taxa baixa em {win_rate:.0f}% - Veja a Tend√™ncia atual.",
                        f"‚ö†Ô∏è {win_rate:.0f}% de vit√≥rias - Analise antes de prosseguir.",
                        f"‚ö†Ô∏è Hist√≥rico de {win_rate:.0f}% - Observe com aten√ß√£o.",
                        f"‚ö†Ô∏è Padr√£o registra {win_rate:.0f}% - Taxa reduzida.",
                        f"‚ö†Ô∏è {win_rate:.0f}% acumulado - Considere a tend√™ncia."
                    ]
                    dicas.append(random.choice(risk_tips))
                else:
                    moderate_tips = [
                        f"üü° Taxa de {win_rate:.0f}% - Desempenho equilibrado.",
                        f"üü° Padr√£o com {win_rate:.0f}% - Analise o hist√≥rico.",
                        f"üü° {win_rate:.0f}% de acerto - Considere a tend√™ncia.",
                        f"üü° Taxa m√©dia de {win_rate:.0f}% - Risco moderado.",
                        f"üü° {win_rate:.0f}% no padr√£o - Avalie os resultados anteriores.",
                        f"üü° Hist√≥rico em {win_rate:.0f}% - Observe analise os statusdo dia.",
                        f"üü° {win_rate:.0f}% de vit√≥rias - Desempenho est√°vel.",
                        f"üü° Taxa de {win_rate:.0f}% acumulada - Considere a tend√™ncia.",
                        f"üü° Padr√£o registra {win_rate:.0f}% - Veja a tend√™ncia.",
                        f"üü° {win_rate:.0f}% de sucesso - Analise o cen√°rio.",
                        f"üü° Taxa moderada de {win_rate:.0f}% - Observe o comportamento do padr√£o.",
                        f"üü° {win_rate:.0f}% no hist√≥rico - Considere os indicadores.",
                        f"üü° Padr√£o com {win_rate:.0f}% - Avalie o desempenho atual do padr√£o.",
                        f"üü° {win_rate:.0f}% de acerto - risco moderado.",
                        f"üü° Taxa de vit√≥rias em {win_rate:.0f}% - Analise com aten√ß√£o.",
                        f"üü° {win_rate:.0f}% acumulado - Observe o comportamento do padr√£o no dia.",
                        f"üü° Padr√£o em {win_rate:.0f}% - Considere a tend√™ncia atual.",
                        f"üü° Taxa de {win_rate:.0f}% - risco moderado.",
                        f"üü° {win_rate:.0f}% de sucesso - Veja o hist√≥rico recente.",
                        f"üü° {win_rate:.0f}% no padr√£o - Analise a tend√™ncia."
                    ]
                    dicas.append(random.choice(moderate_tips))
                
                if branco_rate >= 16:
                    branco_tips = [
                        f"‚ö™Ô∏è Taxa de branco em {branco_rate:.0f}% - Considere o hist√≥rico.",
                        f"‚ö™Ô∏è {branco_rate:.0f}% de incid√™ncia de branco - Avalie o risco.",
                        f"‚ö™Ô∏è Branco registra {branco_rate:.0f}% - Observe o padr√£o.",
                        f"‚ö™Ô∏è Alta taxa de {branco_rate:.0f}% em branco - Veja os dados.",
                        f"‚ö™Ô∏è {branco_rate:.0f}% de branco no hist√≥rico - Analise a Tend√™ncia.",
                        f"‚ö™Ô∏è Padr√£o com {branco_rate:.0f}% de branco - Considere os n√∫meros.",
                        f"‚ö™Ô∏è Taxa elevada de {branco_rate:.0f}% - Observe os indicadores.",
                        f"‚ö™Ô∏è {branco_rate:.0f}% de branco acumulado - Avalie o cen√°rio.",
                        f"‚ö™Ô∏è Branco em {branco_rate:.0f}% - Veja o desempenho.",
                        f"‚ö™Ô∏è {branco_rate:.0f}% de incid√™ncia - Considere a tend√™ncia.",
                        f"‚ö™Ô∏è Taxa de {branco_rate:.0f}% em branco - Analise os sinais.",
                        f"‚ö™Ô∏è Padr√£o registra {branco_rate:.0f}% - Observe com aten√ß√£o.",
                        f"‚ö™Ô∏è {branco_rate:.0f}% de branco - Avalie o contexto.",
                        f"‚ö™Ô∏è Alta presen√ßa de {branco_rate:.0f}% - Veja o hist√≥rico.",
                        f"‚ö™Ô∏è {branco_rate:.0f}% em branco - Considere a Tend√™ncia atual.",
                        f"‚ö™Ô∏è Taxa de branco com {branco_rate:.0f}% - Analise o padr√£o.",
                        f"‚ö™Ô∏è {branco_rate:.0f}% de incid√™ncia - Observe o comportamento.",
                        f"‚ö™Ô∏è Branco acumula {branco_rate:.0f}% - Avalie os resultados.",
                        f"‚ö™Ô∏è Padr√£o com {branco_rate:.0f}% em branco - Veja os n√∫meros.",
                        f"‚ö™Ô∏è {branco_rate:.0f}% de branco registrado - Considere os dados."
                    ]
                    dicas.append(random.choice(branco_tips))
                
                if media_wins >= 2:
                    streak_tips = [
                        f"üìà {media_wins} vit√≥rias consecutivas - Analise o hist√≥rico.",
                        f"üìà Padr√£o com {media_wins} acertos seguidos - Veja a Tend√™ncia.",
                        f"üìà {media_wins} wins em sequ√™ncia - Considere o desempenho.",
                        f"üìà Sequ√™ncia de {media_wins} vit√≥rias - Observe os dados.",
                        f"üìà {media_wins} acertos consecutivos - Avalie a tend√™ncia.",
                        f"üìà Padr√£o registra {media_wins} wins seguidos - Veja o comportamento do padr√£o.",
                        f"üìà {media_wins} vit√≥rias em fila - Analise o comportamento do padr√£o.",
                        f"üìà Sequ√™ncia com {media_wins} acertos - Considere a tend√™ncia.",
                        f"üìà {media_wins} wins consecutivos - Observe o padr√£o.",
                        f"üìà Taxa de {media_wins} vit√≥rias seguidas - Avalie o timing.",
                        f"üìà {media_wins} acertos em sequ√™ncia - Veja o desempenho.",
                        f"üìà Padr√£o em {media_wins} wins seguidos - Analise os sinais.",
                        f"üìà {media_wins} vit√≥rias acumuladas - Considere a Tend√™ncia atual.",
                        f"üìà Sequ√™ncia de {media_wins} acertos - Observe os indicadores.",
                        f"üìà {media_wins} wins em fila - Avalie o hist√≥rico recente.",
                        f"üìà Padr√£o com {media_wins} vit√≥rias - Veja o comportamento.",
                        f"üìà {media_wins} acertos consecutivos - Considere os resultados.",
                        f"üìà Sequ√™ncia registra {media_wins} wins - Analise o padr√£o.",
                        f"üìà {media_wins} vit√≥rias seguidas - Observe o cen√°rio atual.",
                        f"üìà {media_wins} wins consecutivos - Avalie os dados."
                    ]
                    dicas.append(random.choice(streak_tips))
                
                dicas_str = "\n".join(dicas) if dicas else "üí° Sem dados suficientes - Analise o padr√£o."
            
                mensagem = f"""
‚îå‚îÄ‚îÄ üéØ *ENTRADA CONFIRMADA* ‚îÄ‚îÄ‚îê  
‚îÇ *Padr√£o:* {padrao_emotes}  
‚îÇ *Apareceu {count_today} vezes hoje*  
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  
‚îÇ *Apostar:* {self.direction_color}  
‚îÇ ‚è≥ *Entrar Ap√≥s o N¬∫:* {last_number if last_number else 'N/A'}  
‚îÇ ‚ö™Ô∏è *Proteger:* Branco  
‚îÇ üîÑ *At√©:* 2 Gales  
‚îú‚îÄ üìä *DESEMPENHO AT√â (G2)* ‚îÄ‚îÄ  
‚îÇ  
‚îÇ ‚úÖ Resultados verificados: {total_tries}  
‚îÇ ‚úÖ {total_wins} Wins na Cor ({win_rate:.0f}%)  
‚îÇ ‚ö™Ô∏è {total_brancos} Brancos ({branco_rate:.0f}%)  
‚îÇ ‚úÖ Wins Cor + Branco: ({win_plus_branco_rate:.0f}%)  
‚îÇ üíÄ {total_losses} Loss ({loss_rate:.0f}%)  
‚îÇ  
‚îú‚îÄ üìà *STATUS HOJE* ‚îÄ‚îÄ  
‚îÇ  
‚îÇ ‚úÖ *Sem Gale:* {wins_sem_gale}  
‚îÇ ‚úÖ *Gale 1:* {wins_gale1}  
‚îÇ ‚úÖ *Gale 2:* {wins_gale2}  
‚îÇ ‚ö™Ô∏è *Branco:* {brancos}  
‚îÇ üö´ *Loss:* {losses}  
‚îÇ üìä *Prob. Total de WIN Hoje:* {prob_win_today:.0f}%  
‚îÇ  
‚îú‚îÄ üìù *STATUS DO PADR√ÉO* ‚îÄ‚îÄ  
‚îÇ {dicas_str}  
‚îî‚îÄ‚îÄ üîó [Blaze]({self.link}) ‚îÄ‚îÄ‚îò  
            """
            except (KeyError, ValueError) as e:
                print(f"Erro ao processar estat√≠sticas do padr√£o: {e}")
                mensagem = f"""
‚îå‚îÄ‚îÄ üéØ *ENTRADA CONFIRMADA* ‚îÄ‚îÄ‚îê  
‚îÇ *Padr√£o:* {padrao_emotes}  
‚îÇ *Status:* Novo  
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  
‚îÇ *Apostar:* {self.direction_color}  
‚îÇ ‚è≥ *Entrar Ap√≥s o N¬∫:* {last_number if last_number else 'N/A'}  
‚îÇ ‚ö™Ô∏è *Proteger:* Branco  
‚îÇ üîÑ *At√©:* 2 Gales  
‚îú‚îÄ üìù *DICA* ‚îÄ‚îÄ  
‚îÇ üí° Padr√£o novo - Analise com cautela.
‚îî‚îÄ‚îÄ üîó [Blaze]({self.link}) ‚îÄ‚îÄ‚îò  
            """
        else:
            mensagem = f"""
‚îå‚îÄ‚îÄ üéØ *ENTRADA CONFIRMADA* ‚îÄ‚îÄ‚îê  
‚îÇ *Padr√£o:* {padrao_emotes}  
‚îÇ *Status:* Novo  
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  
‚îÇ *Apostar:* {self.direction_color}  
‚îÇ ‚è≥ *Entrar Ap√≥s o N¬∫:* {last_number if last_number else 'N/A'}  
‚îÇ ‚ö™Ô∏è *Proteger:* Branco  
‚îÇ üîÑ *At√©:* 2 Gales  
‚îú‚îÄ üìù *DICA* ‚îÄ‚îÄ  
‚îÇ üí° Padr√£o novo - Analise com cautela.
‚îî‚îÄ‚îÄ üîó [Blaze]({self.link}) ‚îÄ‚îÄ‚îò  
        """
    
        try:
            self.bot.send_message(chat_id=self.chat_id, text=mensagem, parse_mode='MARKDOWN')
        except telebot.apihelper.ApiException as e:
            print(f"Erro ao enviar mensagem para o Telegram: {e}")
            self.bot.send_message(chat_id=self.chat_id, text=mensagem, parse_mode=None)
        
        current_time = datetime.datetime.now().strftime("%d/%m/%Y %H:%M:%S")
        self.report_data.append({
            "Data e Hora": current_time,
            "Padrao": ''.join(padrao),
            "Estagio": "Entrada Normal",
            "Resultado": "Pending"
        })
        
        self.generate_report()
        print("Relat√≥rio gerado com sucesso!")
        return

    def martingale(self, result):
        if result == "WIN":
            print(f"WIN")
            self.win_results += 1
            self.max_hate += 1
            self.save_to_history(self.current_pattern, "WIN")
    
            if self.count == 0:
                win_message = "‚úÖ‚úÖ‚úÖ WIN SEM GALE ‚úÖ‚úÖ‚úÖ"
                self.wins_without_gale += 1
                if self.report_data:
                    self.report_data[-1]["Estagio"] = "Martingale 0"
                    self.report_data[-1]["Resultado"] = "WIN"
            elif self.count == 1:
                win_message = "‚úÖ‚úÖ‚úÖ WIN NO G1 ‚úÖ‚úÖ‚úÖ"
                self.wins_martingale_1 += 1
                if self.report_data:
                    self.report_data[-1]["Estagio"] = "Martingale 1"
                    self.report_data[-1]["Resultado"] = "WIN"
            elif self.count == 2:
                win_message = "‚úÖ‚úÖ‚úÖ WIN NO G2 ‚úÖ‚úÖ‚úÖ"
                self.wins_martingale_2 += 1
                if self.report_data:
                    self.report_data[-1]["Estagio"] = "Martingale 2"
                    self.report_data[-1]["Resultado"] = "WIN"
    
            self.bot.send_message(chat_id=self.chat_id, text=win_message)
    
        elif result == "LOSS":
            self.count += 1
            self.save_to_history(self.current_pattern, "LOSS")
            gale_win = False
    
            if self.count > self.gales:
                if not gale_win:
                    print(f"LOSS")
                    self.loss_results += 1
                    self.max_hate = 0
                    self.bot.send_message(chat_id=self.chat_id, text=(f'''üö´üö´üö´ LOSS üö´üö´üö´'''))
                    self.current_strategy_file = 1 - self.current_strategy_file
                    print("Alternando estrat√©gias ap√≥s LOSS")
                    if self.report_data:
                        self.report_data[-1]["Resultado"] = "LOSS"
            else:
                print(f"Vamos para o {self.count}¬™ gale!")
                self.alert_gale()
                return
    
        elif result == "BRANCO":
            print(f"BRANCO")
            self.branco_results += 1
            self.max_hate += 1
            self.save_to_history(self.current_pattern, "BRANCO")
    
            if self.count == 0:
                branco_message = "‚úÖ‚úÖ‚úÖ BRANCO SEM GALE ‚úÖ‚úÖ‚úÖ"
                if self.report_data:
                    self.report_data[-1]["Estagio"] = "Martingale 0"
                    self.report_data[-1]["Resultado"] = "BRANCO"
            elif self.count == 1:
                branco_message = "‚úÖ‚úÖ‚úÖ BRANCO G1 ‚úÖ‚úÖ‚úÖ"
                if self.report_data:
                    self.report_data[-1]["Estagio"] = "Martingale 1"
                    self.report_data[-1]["Resultado"] = "BRANCO"
            elif self.count == 2:
                branco_message = "‚úÖ‚úÖ‚úÖ BRANCO G2 ‚úÖ‚úÖ‚úÖ"
                if self.report_data:
                    self.report_data[-1]["Estagio"] = "Martingale 2"
                    self.report_data[-1]["Resultado"] = "BRANCO"
    
            self.bot.send_message(chat_id=self.chat_id, text=branco_message)
    
        self.generate_report()
        print("Relat√≥rio gerado com sucesso!")
    
        self.count = 0
        self.analisar = True
        self.results()
        self.restart()
    
        if result == "LOSS":
            self.estrategy([])

    def check_results(self, recent_result):
        if recent_result == 'V' and self.direction_color == 'üî¥':
            self.martingale('WIN')
        elif recent_result == 'V' and self.direction_color == '‚ö´Ô∏è':
            self.martingale('LOSS')
        elif recent_result == 'P' and self.direction_color == '‚ö´Ô∏è':
            self.martingale('WIN')
        elif recent_result == 'P' and self.direction_color == 'üî¥':
            self.martingale('LOSS')
        elif recent_result == 'B':
            self.martingale('BRANCO')
        elif recent_result.startswith('G'):
            self.martingale(recent_result)

    def processar_resultado(self, resultado_final):
        for entrada in self.report_data:
            if entrada['Resultado'] == 'Pending':
                entrada['Resultado'] = resultado_final
        self.generate_report()

    def generate_report(self):
        file_path = "report.csv"
        
        existing_data = {}
        try:
            with open(file_path, 'r', newline='', encoding='utf-8') as csvfile:
                reader = csv.DictReader(csvfile)
                for row in reader:
                    existing_data[row['Padrao']] = {
                        'Martingale 0': int(row['Martingale 0']),
                        'Martingale 1': int(row['Martingale 1']),
                        'Martingale 2': int(row['Martingale 2']),
                        'Branco 0': int(row['Branco 0']),
                        'Branco 1': int(row['Branco 1']),
                        'Branco 2': int(row['Branco 2']),
                        'Loss': int(row['Loss'])
                    }
        except FileNotFoundError:
            print(f"Arquivo {file_path} n√£o encontrado. Criando um novo...")
        
        for entry in self.report_data:
            pattern = entry['Padrao']
            resultado = entry['Resultado']
            estagio = entry['Estagio']
            
            if pattern not in existing_data:
                existing_data[pattern] = {
                    'Martingale 0': 0, 'Martingale 1': 0, 'Martingale 2': 0,
                    'Branco 0': 0, 'Branco 1': 0, 'Branco 2': 0, 'Loss': 0
                }
            
            if resultado in ['WIN', 'LOSS', 'BRANCO']:
                if resultado == 'WIN':
                    existing_data[pattern][estagio] += 1
                elif resultado == 'BRANCO':
                    branco_key = f"Branco {estagio[-1]}"
                    existing_data[pattern][branco_key] += 1
                elif resultado == 'LOSS':
                    existing_data[pattern]['Loss'] += 1
        
        headers = ['Padrao', 'Martingale 0', 'Martingale 1', 'Martingale 2', 
                'Branco 0', 'Branco 1', 'Branco 2', 'Loss']
        
        try:
            with open(file_path, 'w', newline='', encoding='utf-8') as csvfile:
                writer = csv.DictWriter(csvfile, fieldnames=headers)
                writer.writeheader()
                
                for pattern, stats in existing_data.items():
                    row = {'Padrao': pattern}
                    row.update(stats)
                    writer.writerow(row)
            
            print(f"‚úÖ CSV atualizado corretamente! Padr√µes salvos: {len(existing_data)}")
        
        except Exception as e:
            print(f"‚ùå Erro ao salvar CSV: {e}")
        
        self.report_data = [entry for entry in self.report_data if entry['Resultado'] == 'Pending']

    def estrategy(self, results):
        finalcor = []
    
        for i in results:
            if i >= 1 and i <= 7: 
                finalcor.append('V')
            elif i >= 8 and i <= 14: 
                finalcor.append('P')
            else:
                finalcor.append('B')
    
        if not self.analisar:
            self.check_results(finalcor[0])
            return
    
        with open(self.strategy_files[self.current_strategy_file], newline='') as f:
            reader = csv.reader(f)
    
            ESTRATEGIAS = []
            for row in reader:
                string = str(row[0])
                split_string = string.split('=')
                values = list(split_string[0])
                dictionary = {'PADRAO': values, 'ENTRADA': split_string[1]}
                ESTRATEGIAS.append(dictionary)
    
            padrao_detectado = False
    
            for i in ESTRATEGIAS:
                detected_pattern = finalcor[:len(i['PADRAO'])][::-1]
                if detected_pattern == i['PADRAO']:
                    print("Padr√£o detectado. Enviando sinal.")
                    padrao_detectado = True
                    if i['ENTRADA'] == 'P':
                        self.direction_color = '‚ö´Ô∏è'
                    elif i['ENTRADA'] == 'V':
                        self.direction_color = 'üî¥'
                    elif i['ENTRADA'] == 'B':
                        self.direction_color = '‚ö™Ô∏è'
                    self.send_sinal(detected_pattern)
                    break
    
            if not padrao_detectado and 'LOSS' in results:
                self.current_strategy_file = 1 - self.current_strategy_file
                print("Alternando estrat√©gias ap√≥s LOSS")

    def start(self):
        self.generate_report()
        print("Relat√≥rio gerado com sucesso!")
        check = []
        while True:
            try:
                self.date_now = str(datetime.datetime.now().strftime("%d/%m/%Y"))

                results = []
                time.sleep(5)

                response = requests.get(self.url_API, timeout=10)
                json_data = json.loads(response.text)
                
                for i in json_data:
                    results.append(i['roll'])

                if check != results:
                    check = results
                    self.delete()
                    self.estrategy(results)

            except Exception as e:
                print(f"Caught an error: {e}")
                continue

# Inicializa√ß√£o
scraper = WebScraper()
scraper.start()